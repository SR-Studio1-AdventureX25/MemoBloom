<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€æ˜è§†é¢‘æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
            background-size: 400% 400%;
            animation: gradientShift 10s ease infinite;
            min-height: 100vh;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 30px;
        }

        .video-container {
            position: relative;
            display: inline-block;
            margin: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        video {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .info {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .controls {
            margin: 20px 0;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        .pattern-bg {
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.1) 10px, rgba(255,255,255,.1) 20px),
                repeating-linear-gradient(-45deg, transparent, transparent 10px, rgba(0,0,0,.1) 10px, rgba(0,0,0,.1) 20px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ é€æ˜è§†é¢‘é€šé“æµ‹è¯•</h1>
        
        <div class="info">
            <h3>æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•MOVè§†é¢‘æ–‡ä»¶çš„é€æ˜é€šé“ï¼ˆAlpha Channelï¼‰æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
            <p>å¦‚æœè§†é¢‘åŒ…å«é€æ˜é€šé“ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°èƒŒæ™¯è‰²å½©é€è¿‡è§†é¢‘çš„é€æ˜éƒ¨åˆ†æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
        </div>

        <div class="controls">
            <button onclick="toggleBackground()">åˆ‡æ¢èƒŒæ™¯æ¨¡å¼</button>
            <button onclick="toggleVideoSize()">åˆ‡æ¢è§†é¢‘å°ºå¯¸</button>
        </div>

        <div class="video-container" id="videoContainer">
            <!-- éšè—çš„videoå…ƒç´ ï¼Œç”¨äºåŠ è½½è§†é¢‘ -->
            <video 
                id="hiddenVideo"
                loop 
                autoplay 
                muted
                style="display: none;"
            >
                <source src="tests/é£ä¹¦20250724-221207.mov" type="video/quicktime">
            </video>
            
            <!-- Canvasç”¨äºæ¸²æŸ“é€æ˜è§†é¢‘ -->
            <canvas 
                id="transparentCanvas"
                width="600"
                height="400"
                style="border-radius: 10px; cursor: pointer;"
            ></canvas>
            
            <!-- æ§åˆ¶æŒ‰é’® -->
            <div style="margin-top: 10px;">
                <button id="playPauseBtn" onclick="togglePlayPause()">â–¶ï¸ æ’­æ”¾</button>
                <button onclick="restartVideo()">ğŸ”„ é‡æ’­</button>
            </div>
        </div>

        <div class="info">
            <h3>ğŸ” é€æ˜é€šé“æ£€æµ‹</h3>
            <div id="debugInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: left; font-family: monospace; font-size: 12px;">
                <div id="videoInfo">æ­£åœ¨åˆ†æè§†é¢‘...</div>
                <div id="alphaInfo">æ­£åœ¨æ£€æµ‹é€æ˜é€šé“...</div>
                <div id="pixelInfo">åƒç´ åˆ†æå¾…å¼€å§‹...</div>
            </div>
            <button onclick="analyzeTransparency()" style="background: #2196F3;">ğŸ” åˆ†æé€æ˜é€šé“</button>
        </div>

        <div class="info">
            <h3>æ£€æŸ¥è¦ç‚¹</h3>
            <ul style="text-align: left;">
                <li><strong>é€æ˜æ•ˆæœï¼š</strong>è§†é¢‘ä¸­çš„é€æ˜éƒ¨åˆ†åº”è¯¥æ˜¾ç¤ºèƒŒæ™¯é¢œè‰²</li>
                <li><strong>è¾¹ç¼˜è´¨é‡ï¼š</strong>é€æ˜è¾¹ç¼˜åº”è¯¥å¹³æ»‘ï¼Œæ²¡æœ‰ç™½è¾¹æˆ–é»‘è¾¹</li>
                <li><strong>è‰²å½©ä¿çœŸï¼š</strong>éé€æ˜éƒ¨åˆ†çš„é¢œè‰²åº”è¯¥å‡†ç¡®æ˜¾ç¤º</li>
                <li><strong>æ’­æ”¾æµç•…ï¼š</strong>è§†é¢‘åº”è¯¥èƒ½å¤Ÿæ­£å¸¸æ’­æ”¾ï¼Œæ²¡æœ‰å¡é¡¿</li>
            </ul>
        </div>

        <div class="info">
            <h3>æµè§ˆå™¨å…¼å®¹æ€§</h3>
            <p><strong>æ”¯æŒé€æ˜è§†é¢‘çš„æµè§ˆå™¨ï¼š</strong></p>
            <ul style="text-align: left;">
                <li>Safari (æœ€ä½³æ”¯æŒ)</li>
                <li>Chrome/Edge (éƒ¨åˆ†æ”¯æŒ)</li>
                <li>Firefox (æœ‰é™æ”¯æŒ)</li>
            </ul>
            <p><em>æ³¨æ„ï¼šä¸åŒæµè§ˆå™¨å¯¹é€æ˜è§†é¢‘çš„æ”¯æŒç¨‹åº¦ä¸åŒï¼Œå»ºè®®åœ¨Safariä¸­æµ‹è¯•ä»¥è·å¾—æœ€ä½³æ•ˆæœã€‚</em></p>
        </div>
    </div>

    <script>
        let isPatternBackground = false;
        let isLargeSize = false;
        let isPlaying = false;
        let animationId = null;

        // è·å–å…ƒç´ 
        const video = document.getElementById('hiddenVideo');
        const canvas = document.getElementById('transparentCanvas');
        const ctx = canvas.getContext('2d');
        const playPauseBtn = document.getElementById('playPauseBtn');

        function toggleBackground() {
            const body = document.body;
            if (isPatternBackground) {
                body.classList.remove('pattern-bg');
                body.style.background = 'linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7)';
                body.style.backgroundSize = '400% 400%';
                body.style.animation = 'gradientShift 10s ease infinite';
                isPatternBackground = false;
            } else {
                body.style.background = '#f0f0f0';
                body.style.animation = 'none';
                body.classList.add('pattern-bg');
                isPatternBackground = true;
            }
        }

        function toggleVideoSize() {
            const canvas = document.getElementById('transparentCanvas');
            if (isLargeSize) {
                canvas.width = 600;
                canvas.height = 400;
                canvas.style.width = '600px';
                canvas.style.height = '400px';
                isLargeSize = false;
            } else {
                canvas.width = 800;
                canvas.height = 600;
                canvas.style.width = '800px';
                canvas.style.height = '600px';
                isLargeSize = true;
            }
        }

        function togglePlayPause() {
            if (isPlaying) {
                video.pause();
                cancelAnimationFrame(animationId);
                playPauseBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
                isPlaying = false;
            } else {
                video.play();
                renderFrame();
                playPauseBtn.textContent = 'â¸ï¸ æš‚åœ';
                isPlaying = true;
            }
        }

        function restartVideo() {
            video.currentTime = 0;
            if (!isPlaying) {
                video.play();
                renderFrame();
                playPauseBtn.textContent = 'â¸ï¸ æš‚åœ';
                isPlaying = true;
            }
        }

        function renderFrame() {
            if (video.readyState >= 2) {
                // æ¸…é™¤ç”»å¸ƒï¼ˆè¿™æ ·å°±èƒ½æ˜¾ç¤ºé€æ˜èƒŒæ™¯ï¼‰
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶è§†é¢‘å¸§åˆ°ç”»å¸ƒ
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }
            
            if (isPlaying && !video.paused && !video.ended) {
                animationId = requestAnimationFrame(renderFrame);
            }
        }

        // è§†é¢‘åŠ è½½é”™è¯¯å¤„ç†
        video.addEventListener('error', function(e) {
            console.error('è§†é¢‘åŠ è½½å¤±è´¥:', e);
            const container = document.getElementById('videoContainer');
            container.innerHTML = `
                <div style="padding: 40px; background: rgba(255,0,0,0.1); border: 2px dashed #ff6b6b; border-radius: 10px;">
                    <h3 style="color: #d63031; margin: 0;">âš ï¸ è§†é¢‘åŠ è½½å¤±è´¥</h3>
                    <p style="margin: 10px 0;">è¯·æ£€æŸ¥è§†é¢‘æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼š<code>tests/é£ä¹¦20250724-221207.mov</code></p>
                    <p style="margin: 10px 0; font-size: 14px; color: #666;">
                        å¯èƒ½çš„åŸå› ï¼š<br>
                        1. æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®<br>
                        2. æµè§ˆå™¨ä¸æ”¯æŒè¯¥è§†é¢‘æ ¼å¼<br>
                        3. éœ€è¦åœ¨æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œ<br>
                        4. è§†é¢‘æ–‡ä»¶å¯èƒ½æ²¡æœ‰é€æ˜é€šé“
                    </p>
                </div>
            `;
        });

        // è§†é¢‘æˆåŠŸåŠ è½½æ—¶çš„å¤„ç†
        video.addEventListener('loadeddata', function() {
            console.log('è§†é¢‘åŠ è½½æˆåŠŸï¼');
            // è°ƒæ•´Canvaså°ºå¯¸ä»¥åŒ¹é…è§†é¢‘
            canvas.width = video.videoWidth || 600;
            canvas.height = video.videoHeight || 400;
            
            // å¼€å§‹æ¸²æŸ“
            isPlaying = true;
            renderFrame();
        });

        // è§†é¢‘æ’­æ”¾çŠ¶æ€å˜åŒ–
        video.addEventListener('play', function() {
            isPlaying = true;
            renderFrame();
            playPauseBtn.textContent = 'â¸ï¸ æš‚åœ';
        });

        video.addEventListener('pause', function() {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            playPauseBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
        });

        video.addEventListener('ended', function() {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            playPauseBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
        });

        // Canvasç‚¹å‡»äº‹ä»¶
        canvas.addEventListener('click', togglePlayPause);

        // é€æ˜é€šé“åˆ†æå‡½æ•°
        function analyzeTransparency() {
            const videoInfo = document.getElementById('videoInfo');
            const alphaInfo = document.getElementById('alphaInfo');
            const pixelInfo = document.getElementById('pixelInfo');

            if (video.readyState < 2) {
                alphaInfo.innerHTML = 'âŒ è§†é¢‘å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç­‰å¾…...';
                return;
            }

            // æ›´æ–°è§†é¢‘ä¿¡æ¯
            videoInfo.innerHTML = `
                ğŸ“¹ è§†é¢‘ä¿¡æ¯: ${video.videoWidth}Ã—${video.videoHeight}px, 
                æ—¶é•¿: ${video.duration.toFixed(1)}s, 
                æ ¼å¼: ${video.currentSrc.split('.').pop().toUpperCase()}
            `;

            // åˆ›å»ºä¸´æ—¶canvasè¿›è¡Œåƒç´ åˆ†æ
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = Math.min(video.videoWidth, 200);
            tempCanvas.height = Math.min(video.videoHeight, 200);

            // ç»˜åˆ¶å½“å‰å¸§
            tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);

            try {
                // è·å–åƒç´ æ•°æ®
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
                
                let totalPixels = 0;
                let transparentPixels = 0;
                let semiTransparentPixels = 0;
                let opaquePixels = 0;
                let alphaValues = [];

                // åˆ†ææ¯ä¸ªåƒç´ çš„alphaå€¼
                for (let i = 3; i < data.length; i += 4) {
                    const alpha = data[i];
                    alphaValues.push(alpha);
                    totalPixels++;

                    if (alpha === 0) {
                        transparentPixels++;
                    } else if (alpha === 255) {
                        opaquePixels++;
                    } else {
                        semiTransparentPixels++;
                    }
                }

                // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                const transparentPercentage = (transparentPixels / totalPixels * 100).toFixed(1);
                const semiTransparentPercentage = (semiTransparentPixels / totalPixels * 100).toFixed(1);
                const opaquePercentage = (opaquePixels / totalPixels * 100).toFixed(1);

                const minAlpha = Math.min(...alphaValues);
                const maxAlpha = Math.max(...alphaValues);
                const avgAlpha = (alphaValues.reduce((a, b) => a + b, 0) / alphaValues.length).toFixed(1);

                // åˆ¤æ–­æ˜¯å¦æœ‰é€æ˜é€šé“
                const hasTransparency = transparentPixels > 0 || semiTransparentPixels > 0 || minAlpha < 255;

                if (hasTransparency) {
                    alphaInfo.innerHTML = `âœ… <strong>æ£€æµ‹åˆ°é€æ˜é€šé“ï¼</strong>`;
                    pixelInfo.innerHTML = `
                        ğŸ” åƒç´ åˆ†æ (æ ·æœ¬: ${totalPixels}px):<br>
                        â€¢ å®Œå…¨é€æ˜: ${transparentPixels} (${transparentPercentage}%)<br>
                        â€¢ åŠé€æ˜: ${semiTransparentPixels} (${semiTransparentPercentage}%)<br>
                        â€¢ ä¸é€æ˜: ${opaquePixels} (${opaquePercentage}%)<br>
                        â€¢ AlphaèŒƒå›´: ${minAlpha} - ${maxAlpha} (å¹³å‡: ${avgAlpha})
                    `;
                } else {
                    alphaInfo.innerHTML = `âŒ <strong>æœªæ£€æµ‹åˆ°é€æ˜é€šé“</strong> - æ‰€æœ‰åƒç´ éƒ½æ˜¯ä¸é€æ˜çš„`;
                    pixelInfo.innerHTML = `
                        ğŸ” åƒç´ åˆ†æç»“æœ:<br>
                        â€¢ è§†é¢‘æ–‡ä»¶å¯èƒ½ä¸åŒ…å«Alphaé€šé“<br>
                        â€¢ æˆ–è€…å½“å‰å¸§æ²¡æœ‰é€æ˜å†…å®¹<br>
                        â€¢ Alphaå€¼å‡ä¸º: ${maxAlpha} (å®Œå…¨ä¸é€æ˜)<br>
                        <br>
                        ğŸ’¡ <strong>å»ºè®®</strong>:<br>
                        1. æ£€æŸ¥è§†é¢‘å¯¼å‡ºæ—¶æ˜¯å¦å¯ç”¨äº†Alphaé€šé“<br>
                        2. ç¡®è®¤è§†é¢‘ç¼–ç æ”¯æŒé€æ˜åº¦ (å¦‚ProRes 4444)<br>
                        3. å°è¯•å…¶ä»–å¸§æˆ–æ—¶é—´ç‚¹è¿›è¡Œåˆ†æ
                    `;
                }

                // å¦‚æœæœ‰é€æ˜åº¦ä½†é¡µé¢æ²¡æ˜¾ç¤ºï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜
                if (hasTransparency) {
                    pixelInfo.innerHTML += `<br><br>ğŸ¯ <strong>å¦‚æœé€æ˜æ•ˆæœæ²¡æœ‰æ˜¾ç¤º</strong>:<br>
                        â€¢ å°è¯•åœ¨Safariæµè§ˆå™¨ä¸­æ‰“å¼€ (æœ€ä½³æ”¯æŒ)<br>
                        â€¢ ç¡®ä¿ä½¿ç”¨HTTPSæˆ–æœ¬åœ°æœåŠ¡å™¨<br>
                        â€¢ æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯`;
                }

            } catch (error) {
                alphaInfo.innerHTML = `âŒ åˆ†æå¤±è´¥: ${error.message}`;
                pixelInfo.innerHTML = `å¯èƒ½åŸå› : CORSé™åˆ¶æˆ–è§†é¢‘ç¼–ç é—®é¢˜<br>
                    å»ºè®®: å°è¯•åœ¨æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œæ­¤é¡µé¢`;
                console.error('é€æ˜é€šé“åˆ†æé”™è¯¯:', error);
            }
        }

        // è‡ªåŠ¨åœ¨è§†é¢‘åŠ è½½åè¿›è¡Œåˆ†æ
        video.addEventListener('loadeddata', function() {
            console.log('è§†é¢‘åŠ è½½æˆåŠŸï¼');
            // è°ƒæ•´Canvaså°ºå¯¸ä»¥åŒ¹é…è§†é¢‘
            canvas.width = video.videoWidth || 600;
            canvas.height = video.videoHeight || 400;
            
            // å¼€å§‹æ¸²æŸ“
            isPlaying = true;
            renderFrame();

            // å»¶è¿Ÿåˆ†æï¼Œç¡®ä¿è§†é¢‘å¸§å¯ç”¨
            setTimeout(() => {
                analyzeTransparency();
            }, 500);
        });
    </script>
</body>
</html>
